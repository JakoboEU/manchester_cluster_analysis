---
title: "Indicator species by cluster"
output: html_notebook
---

# Set Up
## Load Libs
```{r}
library(indicspecies)
library(dplyr)
library(tidyverse)
```

## Constants
```{r}
SOME_SEED = 7442
LINES_TO_GUESS_TYPES = 1000
INPUT_DIR = 'input'
```

## Helper functions
```{r}
read_input_csv = function(filename) {
  read_csv(paste(INPUT_DIR, filename, sep = '/'), guess_max = LINES_TO_GUESS_TYPES)
}

to_presence_dataframe = function(presence_data) {
  presence_data %>% dplyr::mutate(present = T) %>% pivot_wider(id_cols = title, names_from = species, values_from = present, values_fill = F)
}

include_sites_with_no_presence_record = function(presence_df, all_plot_titles) {
  sites_with_no_records = data.frame(title = data.frame(title = all_plot_titles) %>% filter(!(title %in% presence_df$title)) %>% dplyr::select(title))
  species_names = colnames(presence_df)[-1]
  for(species_name in species_names) {
    sites_with_no_records[species_name] = F
  }
  
  rbind(presence_df, sites_with_no_records)
}

to_indicator_species_matrix = function(per_site) {
  per_site %>% dplyr::select(-title) %>% mutate(across(everything(), as.integer)) %>% as.matrix
}
```


# Clusters
## Plant and Insect
```{r}
plant_and_insect_clusters = read_input_csv('insect-plant-clusters.csv') %>%
  pivot_longer(!k, names_to = "title", values_to = "col2") %>% 
  pivot_wider(names_from = "k", values_from = "col2")
plant_and_insect_clusters
```
```{r}
bird_clusters = read_input_csv('bird-clusters.csv') %>%
  pivot_longer(!k, names_to = "title", values_to = "col2") %>% 
  pivot_wider(names_from = "k", values_from = "col2")
bird_clusters
```

# Species Presence
```{r}
insects_per_site = read_input_csv('insect-presence.csv') %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(plant_and_insect_clusters$title) %>% 
  arrange(title)
insects_per_site
```

```{r}
plants_per_site = read_input_csv('plant-presence.csv') %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(plant_and_insect_clusters$title) %>% 
  arrange(title)
plants_per_site
```

```{r}
birds_per_site = read_input_csv('bird-presence.csv') %>% 
  to_presence_dataframe() %>% 
  include_sites_with_no_presence_record(bird_clusters$title) %>% 
  arrange(title)
birds_per_site
```

# Insect Indicators
## (k = 3)
```{r}
insects_per_site_matrix = to_indicator_species_matrix(insects_per_site)
plants_per_site_matrix = to_indicator_species_matrix(plants_per_site)
birds_per_site_matrix = to_indicator_species_matrix(birds_per_site)

indicator_species = function(species_matrix, cluster_assignment) {
  set.seed(SOME_SEED)
  cluster_fact = factor(cluster_assignment)
  multipatt(species_matrix, cluster_fact, control = how(nperm=999))
}

insect_indicator_species = function(cluster_assignment) {indicator_species(insects_per_site_matrix, cluster_assignment)}
plant_indicator_species = function(cluster_assignment) {indicator_species(plants_per_site_matrix, cluster_assignment)}
bird_indicator_species = function(cluster_assignment) {indicator_species(birds_per_site_matrix, cluster_assignment)}

insects_k3 = insect_indicator_species(plant_and_insect_clusters$`3`)
summary(insects_k3)
```

```{r}
as.data.frame(insects_k3$sign)
```

```{r}
indicator_species_stats = function(k, indicator_results) {
  not_generalist_species = nrow(indicator_results$sign[!is.na(indicator_results$sign$p.value),])
  
  data.frame(
    k = k,
    number_not_generalist = not_generalist_species,
    proportion_not_generalist = not_generalist_species / nrow(indicator_results$sign),
    average_p_value = mean(indicator_results$sign$p.value, na.rm = T)
  )
}
summary_3 = indicator_species_stats(3, insects_k3)
summary_3
```
# Insect Final Results
```{r}
bind_rows(
  summary_3,
  indicator_species_stats(6, plant_indicator_species(plant_and_insect_clusters$`6`)),
  indicator_species_stats(8, plant_indicator_species(plant_and_insect_clusters$`8`)),
  indicator_species_stats(15, plant_indicator_species(plant_and_insect_clusters$`15`)))
```

```{r}
insects_k8 = insect_indicator_species(plant_and_insect_clusters$`8`)
```

Generalists
```{r}
insects_k8$sign[is.na(insects_k8$sign$p.value),]
```

```{r}
summary(insects_k8)
```

# Plant Indicators

```{r}
bind_rows(
  indicator_species_stats(3, plant_indicator_species(plant_and_insect_clusters$`3`)),
  indicator_species_stats(6, plant_indicator_species(plant_and_insect_clusters$`6`)),
  indicator_species_stats(8, plant_indicator_species(plant_and_insect_clusters$`8`)),
  indicator_species_stats(15, plant_indicator_species(plant_and_insect_clusters$`15`)))
```

```{r}
plants_k8 = plant_indicator_species(plant_and_insect_clusters$`8`)
```

Generalists
```{r}
plants_k8$sign[is.na(plants_k8$sign$p.value),]
```

```{r}
summary(plants_k8)
```

# Bird Indicators
```{r}
bind_rows(
  indicator_species_stats(3, bird_indicator_species(bird_clusters$`3`)), 
  indicator_species_stats(6, bird_indicator_species(bird_clusters$`6`)), 
  indicator_species_stats(7, bird_indicator_species(bird_clusters$`7`)), 
  indicator_species_stats(7, bird_indicator_species(bird_clusters$`7`)), 
  indicator_species_stats(9, bird_indicator_species(bird_clusters$`9`)), 
  indicator_species_stats(15, bird_indicator_species(bird_clusters$`15`))
)
```
```{r}
birds_k8 = plant_indicator_species(bird_clusters$`8`)
```

Generalists
```{r}
birds_k8$sign[is.na(birds_k8$sign$p.value),]
```

```{r}
summary(birds_k8)
```
